<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Moltbot ‚Äî GGUF local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:radial-gradient(circle at top,#0f172a,#020617); color:#e5e7eb; }
    header { padding:16px; font-weight:700; background:rgba(0,0,0,.4); backdrop-filter:blur(8px); }
    .chat { padding:16px; max-width:820px; margin:auto; padding-bottom:90px; }
    .msg { margin-bottom:12px; padding:12px 14px; border-radius:12px; max-width:80%; white-space:pre-wrap; word-break:break-word; }
    .bot { background:#064e3b; }
    .user { background:#1d4ed8; margin-left:auto; text-align:right; }
    .mini { opacity:.8; font-size:13px; margin-top:6px; }
    footer { position:fixed; bottom:0; left:0; right:0; padding:12px; background:rgba(0,0,0,.5); backdrop-filter:blur(8px); display:flex; gap:8px; }
    input { flex:1; padding:12px; border-radius:10px; border:none; outline:none; font-size:16px; }
    button { padding:12px 16px; border-radius:10px; border:none; background:#2563eb; color:#fff; font-weight:700; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.08); font-size:12px; margin-left:8px; }
  </style>
</head>
<body>
  <header>üß† Moltbot ‚Äî GGUF local <span class="pill" id="pill">pr√™t</span></header>

  <div class="chat" id="chat">
    <div class="msg bot">Salut Mohammed. Je suis Moltbot.<br>Dis-moi ce que tu veux faire.</div>
  </div>

  <footer>
    <input id="input" placeholder="√âcris √† Moltbot‚Ä¶" />
    <button id="btn" onclick="send()">Envoyer</button>
  </footer>

  <script>
    const chatEl = document.getElementById("chat");
    const input = document.getElementById("input");
    const pill = document.getElementById("pill");
    const btn = document.getElementById("btn");

    function add(text, cls) {
      const d = document.createElement("div");
      d.className = "msg " + cls;
      d.textContent = text;
      chatEl.appendChild(d);
      window.scrollTo(0, document.body.scrollHeight);
      return d;
    }

    async function health() {
      try {
        const r = await fetch("/api/health");
        const j = await r.json();
        pill.textContent = j.ready ? "pr√™t" : (j.booting ? "d√©marrage‚Ä¶" : "chauffe‚Ä¶");
      } catch (_) {
        pill.textContent = "offline";
      }
    }
    setInterval(health, 2500);
    health();

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      add(text, "user");

      btn.disabled = true;
      const status = add("‚è≥ Moltbot r√©fl√©chit‚Ä¶", "bot");

      const MAX_RETRY = 20; // ‚úÖ stop boucle infinie
      for (let i = 0; i < MAX_RETRY; i++) {
        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
          });

          const data = await res.json();

          if (!res.ok) {
            // 503 => on attend un peu, puis on retente
            if (data?.error?.code === 503) {
              status.textContent = "‚è≥ Chargement du mod√®le‚Ä¶";
              await new Promise(r => setTimeout(r, 1200));
              continue;
            }
            status.textContent = `‚ùå ${data?.error?.message || "Erreur inconnue"}`;
            btn.disabled = false;
            return;
          }

          status.textContent = data.reply || "‚ö†Ô∏è R√©ponse vide";
          btn.disabled = false;
          return;

        } catch (e) {
          status.textContent = "‚ö†Ô∏è Erreur r√©seau, retry‚Ä¶";
          await new Promise(r => setTimeout(r, 1200));
        }
      }

      status.textContent = "‚ùå Toujours en chargement apr√®s plusieurs essais. Recharge la page (Render free peut sleep) ou regarde /api/health.";
      btn.disabled = false;
    }

    input.addEventListener("keydown", e => { if (e.key === "Enter") send(); });
  </script>
</body>
</html>
